<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>みんなのノート Pro</title>
    <style>
        /* 外部読み込みを一切しない標準CSS */
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ヘッダー */
        nav {
            background-color: #1e3a8a;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .nav-title { font-weight: bold; font-size: 14px; }

        .role-btn {
            font-size: 10px;
            padding: 4px 12px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            margin-left: 5px;
        }
        .btn-active { background-color: #2563eb; }
        .btn-inactive { background-color: #4b5563; }

        /* メインエリア */
        .container {
            flex-grow: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .status-bar {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border-left: 8px solid #2563eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .toolbar {
            background: white;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            z-index: 50;
        }

        /* キャンバス */
        .canvas-wrap {
            position: relative;
            flex-grow: 1;
            background: white;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            border-top: none;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .task-bg {
            position: absolute;
            inset: 0;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 5;
        }

        /* ツールボタン */
        .color-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            padding: 0;
        }
        .active-tool { outline: 4px solid #60a5fa; }

        .size-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9fafb;
            padding: 4px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
        }

        .clear-btn {
            margin-left: auto;
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fee2e2;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* 消しゴムプレビュー */
        #eraser-cursor {
            position: fixed;
            pointer-events: none;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            z-index: 9999;
            display: none;
            transform: translate(-50%, -50%);
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="eraser-cursor"></div>

<nav>
    <div class="nav-title">みんなのノート Pro</div>
    <div>
        <button onclick="switchRole('student')" id="role-std-btn" class="role-btn btn-active">児童画面</button>
        <button onclick="switchRole('teacher')" id="role-tch-btn" class="role-btn btn-inactive">先生画面</button>
    </div>
</nav>

<div class="container">
    <div class="status-bar">
        <span id="task-title">自由帳</span>
        <div id="teacher-controls" class="hidden">
            <input type="file" id="task-upload" class="hidden" accept="image/*" onchange="handleTaskUpload(event)">
            <button onclick="document.getElementById('task-upload').click()" style="background:#059669; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:11px; cursor:pointer;">課題を配信</button>
        </div>
    </div>

    <div class="toolbar">
        <div style="display:flex; gap:8px;">
            <button onclick="setMode('pen', '#000000')" id="btn-black" class="color-btn" style="background:black;"></button>
            <button onclick="setMode('pen', '#ef4444')" id="btn-red" class="color-btn" style="background:#ef4444;"></button>
            <button onclick="setMode('pen', '#3b82f6')" id="btn-blue" class="color-btn" style="background:#3b82f6;"></button>
            <button onclick="setMode('eraser')" id="btn-eraser" class="color-btn" style="background:white; display:flex; align-items:center; justify-content:center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.9-9.9c1-1 2.5-1 3.4 0l4.4 4.4c1 1 1 2.5 0 3.4L10.5 21z"/><path d="m15 5 4 4"/></svg>
            </button>
        </div>

        <div class="size-box">
            <span style="font-size:10px; font-weight:bold; color:#666;">太さ</span>
            <input type="range" min="2" max="100" value="5" id="size-slider" oninput="updateSize(this.value)">
            <div id="size-preview" style="width:10px; height:10px; background:black; border-radius:50%;"></div>
        </div>

        <button onclick="clearCanvas()" class="clear-btn">ぜんぶ消す</button>
    </div>

    <div class="canvas-wrap">
        <div id="task-bg" class="task-bg"></div>
        <canvas id="main-canvas"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const eraserCursor = document.getElementById('eraser-cursor');
    const taskBg = document.getElementById('task-bg');
    const sizeSlider = document.getElementById('size-slider');
    const sizePreview = document.getElementById('size-preview');

    let role = 'student';
    let isDrawing = false;
    let isEraser = false;
    let brushColor = '#000000';
    let brushSize = 5;
    let eraserSize = 40;

    function init() {
        resizeCanvas();
        setMode('pen', '#000000');
        const savedTask = localStorage.getItem('current_task_img');
        if (savedTask) {
            taskBg.style.backgroundImage = `url(${savedTask})`;
            document.getElementById('task-title').innerText = "配信された課題";
        }
    }

    function resizeCanvas() {
        const wrap = canvas.parentElement;
        let tempImg = canvas.width > 0 ? canvas.toDataURL() : null;
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        if (tempImg) {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = tempImg;
        }
    }

    window.addEventListener('load', init);
    window.addEventListener('resize', resizeCanvas);

    function switchRole(newRole) {
        role = newRole;
        document.getElementById('role-std-btn').className = `role-btn ${role === 'student' ? 'btn-active' : 'btn-inactive'}`;
        document.getElementById('role-tch-btn').className = `role-btn ${role === 'teacher' ? 'btn-active' : 'btn-inactive'}`;
        document.getElementById('teacher-controls').className = role === 'teacher' ? '' : 'hidden';
    }

    function handleTaskUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const imgData = e.target.result;
            taskBg.style.backgroundImage = `url(${imgData})`;
            document.getElementById('task-title').innerText = "課題を配信しました";
            localStorage.setItem('current_task_img', imgData);
        };
        reader.readAsDataURL(file);
    }

    function setMode(mode, color) {
        isEraser = (mode === 'eraser');
        if (!isEraser) {
            brushColor = color;
            sizeSlider.value = brushSize;
        } else {
            sizeSlider.value = eraserSize;
        }
        updateUI();
    }

    function updateSize(val) {
        if (isEraser) eraserSize = parseInt(val);
        else brushSize = parseInt(val);
        updateUI();
    }

    function updateUI() {
        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active-tool'));
        if (isEraser) {
            document.getElementById('btn-eraser').classList.add('active-tool');
            sizePreview.style.backgroundColor = '#ccc';
            sizePreview.style.width = sizePreview.style.height = (eraserSize/3) + 'px';
        } else {
            const id = brushColor === '#000000' ? 'btn-black' : (brushColor === '#ef4444' ? 'btn-red' : 'btn-blue');
            document.getElementById(id).classList.add('active-tool');
            sizePreview.style.backgroundColor = brushColor;
            sizePreview.style.width = sizePreview.style.height = (brushSize/2 + 2) + 'px';
        }
    }

    function updateEraserCursor(e) {
        if (!isEraser) {
            eraserCursor.style.display = 'none';
            return;
        }
        const cx = e.clientX || (e.touches && e.touches[0].clientX);
        const cy = e.clientY || (e.touches && e.touches[0].clientY);
        if (cx !== undefined) {
            eraserCursor.style.display = 'block';
            eraserCursor.style.width = eraserSize + 'px';
            eraserCursor.style.height = eraserSize + 'px';
            eraserCursor.style.left = cx + 'px';
            eraserCursor.style.top = cy + 'px';
        }
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.clientX || (e.touches && e.touches[0].clientX);
        const cy = e.clientY || (e.touches && e.touches[0].clientY);
        return { x: cx - rect.left, y: cy - rect.top };
    }

    function start(e) {
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        updateEraserCursor(e);
    }

    function move(e) {
        updateEraserCursor(e);
        if (!isDrawing) return;
        if (e.cancelable) e.preventDefault();
        const pos = getPos(e);
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        if (isEraser) {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.lineWidth = eraserSize;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
        }
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function end() {
        isDrawing = false;
        eraserCursor.style.display = 'none';
    }

    canvas.addEventListener('mousedown', start);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', end);
    canvas.addEventListener('mouseenter', (e) => { if(isEraser && !isDrawing) eraserCursor.style.display = 'block'; });
    canvas.addEventListener('mouseleave', () => { if(!isDrawing) eraserCursor.style.display = 'none'; });

    function clearCanvas() {
        if (confirm('すべて消しますか？')) ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
</script>
</body>
</html>
